<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Gestion des lignes de bus</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background:#f4f6f8; }
    header { background:#1e88e5; color:white; padding:15px; font-size:22px; display:flex; justify-content:space-between; align-items:center; }
    .login-btn { background:white; border:none; border-radius:20px; padding:8px 15px; cursor:pointer; }
    .login-btn:hover { background:#e3f2fd; }
    nav { background:#1565c0; padding:10px; display:none; }
    nav button { background:white; border:none; border-radius:20px; padding:8px 15px; margin-right:10px; cursor:pointer; }
    nav button:hover { background:#e3f2fd; }
    .container { padding:20px; }
    .page { display:none; }
    .page.active { display:block; }
    input, select, button { padding:6px; margin:5px 0; }
    ul { list-style:none; padding:0; }
    li { background:white; margin:5px 0; padding:8px; border-radius:8px; display:flex; justify-content:space-between; align-items:center; }
    .delete { background:#e53935; color:white; border:none; border-radius:50%; width:25px; height:25px; cursor:pointer; }
    .delete:hover { background:#c62828; }
    .card { background:white; padding:10px; margin:10px 0; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.1); display:flex; justify-content:space-between; align-items:center; }
    .topbar { margin:10px 0; background:#fff; padding:10px; border-radius:10px; display:none; }
  </style>
</head>
<body>
<header>
  <div>Gestion des lignes de bus</div>
  <button id="loginBtn" class="login-btn" onclick="login()">Se connecter</button>
</header>
<nav id="nav">
  <button onclick="showPage('arrets')">Arrêts</button>
  <button onclick="showPage('lignes')">Lignes</button>
  <button onclick="showPage('regulation')">Régulation</button>
</nav>
<div class="container">

<div id="topbar" class="topbar">
  <b>Fichier de données :</b>
  <button onclick="exportFile()">Télécharger les données</button>
  <input type="file" id="fileInput" accept=".json" onchange="importFile(event)" />
  <span id="statusSync" style="margin-left:10px;color:#2e7d32;"></span>
</div>

<div id="arrets" class="page">
  <h2>Créer des arrêts</h2>
  <input id="nomArret" placeholder="Nom de l'arrêt" />
  <button onclick="addArret()">Ajouter</button>
  <ul id="listeArrets"></ul>
</div>

<div id="lignes" class="page">
  <h2>Créer une ligne</h2>
  <input id="nomLigne" placeholder="Nom de ligne" />
  <div id="selectArrets"></div>
  <button onclick="addLigne()">Créer la ligne</button>
  <div id="listeLignes"></div>
</div>

<div id="regulation" class="page active">
  <h2>Régulation</h2>
  <ul id="regArrets"></ul>
  <div id="resultReg"></div>
</div>
</div>

<script>
let arrets = [];
let lignes = [];
let isLogged = false;

// Charger les données communes depuis GitHub (bus_data.json)
fetch("bus_data.json")
  .then(r => r.json())
  .then(data => { arrets = data.arrets || []; lignes = data.lignes || []; render(); })
  .catch(() => { arrets = []; lignes = []; render(); });

function login(){
  const mdp = prompt("Mot de passe :");
  if(mdp === "5709"){
    isLogged = true;
    document.getElementById('nav').style.display = 'block';
    document.getElementById('topbar').style.display = 'block';
    document.getElementById('loginBtn').style.display = 'none';
    showPage('regulation');
  } else if(mdp !== null) {
    alert("Mot de passe incorrect");
  }
}

function showPage(id){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  render();
}

function save(){
  localStorage.setItem('arrets',JSON.stringify(arrets));
  localStorage.setItem('lignes',JSON.stringify(lignes));
}

function sync(){
  save();
  const s = document.getElementById('statusSync');
  if(s){
    const d = new Date();
    s.textContent = 'Données mises à jour à ' + d.toLocaleTimeString();
  }
}

function exportFile(){
  const data = { arrets, lignes };
  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'bus_data.json';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(a.href);
}

function importFile(e){
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    try{ const data = JSON.parse(ev.target.result); arrets = data.arrets || []; lignes = data.lignes || []; sync(); render(); }
    catch(err){ alert('Fichier invalide'); }
  };
  reader.readAsText(file);
}

function addArret(){ if(!isLogged) return; const nom=document.getElementById('nomArret').value.trim(); if(!nom) return; arrets.push(nom); document.getElementById('nomArret').value=''; sync(); render(); }
function deleteArret(i){ if(!isLogged) return; const nom=arrets[i]; arrets.splice(i,1); lignes.forEach(l=>l.arrets=l.arrets.filter(a=>a.nom!==nom)); sync(); render(); }
function renameArret(i){ if(!isLogged) return; const nouveau = prompt("Nouveau nom de l'arrêt :", arrets[i]); if(!nouveau) return; const ancien = arrets[i]; arrets[i] = nouveau; lignes.forEach(l => l.arrets.forEach(a => { if(a.nom === ancien) a.nom = nouveau; })); sync(); render(); }

function addLigne(){ if(!isLogged) return; const nom=document.getElementById('nomLigne').value.trim(); if(!nom) return; const selected=[]; document.querySelectorAll('.chkArret').forEach(chk=>{ if(chk.checked) selected.push({nom:chk.value,type:chk.dataset.type}); }); lignes.push({nom,arrets:selected}); document.getElementById('nomLigne').value=''; sync(); render(); }
function deleteLigne(i){ if(!isLogged) return; lignes.splice(i,1); sync(); render(); }
function renameLigne(i){ if(!isLogged) return; const nouveau = prompt("Nouveau nom de la ligne :", lignes[i].nom); if(!nouveau) return; lignes[i].nom = nouveau; sync(); render(); }

function render(){
  const ul=document.getElementById('listeArrets'); ul.innerHTML='';
  arrets.forEach((a,i)=>{ const li=document.createElement('li'); li.innerHTML = `${a} ${isLogged?`<div><button onclick='renameArret(${i})'>Renommer</button> <button class='delete' onclick='deleteArret(${i})'>×</button></div>`:''}`; ul.appendChild(li); });

  const sel=document.getElementById('selectArrets'); sel.innerHTML='<h3>Choisir les arrêts</h3>';
  arrets.forEach(a=>{ const d=document.createElement('div'); d.innerHTML=`<input type='checkbox' class='chkArret' value='${a}' data-type='normal'> ${a} <select onchange=\"this.previousElementSibling.dataset.type=this.value\"><option value='normal'>Arrêt</option><option value='depart'>Départ</option><option value='terminus'>Terminus</option></select>`; sel.appendChild(d); });

  const ll=document.getElementById('listeLignes'); ll.innerHTML='<h3>Lignes créées</h3>';
  lignes.forEach((l,i)=>{ const d=document.createElement('div'); d.className='card'; d.innerHTML = `<div><b>${l.nom}</b><br>${l.arrets.map(a=>a.nom+'('+a.type+')').join(' → ')}</div> ${isLogged?`<div><button onclick='renameLigne(${i})'>Renommer</button> <button class='delete' onclick='deleteLigne(${i})'>×</button></div>`:''}`; ll.appendChild(d); });

  const ra=document.getElementById('regArrets'); ra.innerHTML=''; arrets.forEach(a=>{ const li=document.createElement('li'); li.innerHTML=`<button onclick=\"showLinesAt('${a}')\">${a}</button>`; ra.appendChild(li); });
}

function showLinesAt(arret){ const div=document.getElementById('resultReg'); const res=lignes.filter(l=>l.arrets.some(a=>a.nom===arret)); div.innerHTML=`<h3>Lignes à ${arret}</h3>`+(res.length?'<ul>'+res.map(l=>`<li>${l.nom}</li>`).join('')+'</ul>':'Aucune ligne'); }

// Démarrage : page Régulation uniquement, sans onglets ni barre de téléchargement
showPage('regulation');
</script>
</body>
</html>
